wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum clean all
yum makecache


yum -y install gcc curl curl-devel net-snmp net-snmp-devel perl-DBI libxml2-devel libevent-devel pcre mysql-devel
yum -y install  php php-devel  php-fpm  mariadb-server   mariadb-devel
yum -y install php-gd php-mbstring php-bcmath php-mysql php-xml  gd-devel   php-ldap openldap  openldap-devel
yum  -y install nginx 


#useradd zabbix -m -s  /sbin/nologin
groupadd --system zabbix
useradd --system -g zabbix -d /usr/local/zabbix -s /sbin/nologin -c "Zabbix Monitoring System" zabbix

mkdir -m u=rwx,g=rwx,o= -p /usr/local/zabbix
chown -R  zabbix:zabbix /usr/local/zabibx

./configure --prefix=/usr/local/zabbix/ --enable-server --with-mysql --enable-ipv6 --with-net-snmp  --with-libcurl --with-libxml2
make && make install

shell> mysql -uroot -p<password>
mysql> create database zabbix character set utf8 collate utf8_bin;
mysql> create user 'zabbix'@'localhost' identified by '<password>';
mysql> grant all privileges on zabbix.* to 'zabbix'@'localhost';
mysql> quit;


shell> cd database/mysql
 cd /root/zabbix-4.0.19/database/mysql/

shell> mysql -uzabbix -p<password> zabbix < schema.sql
# stop here if you are creating database for Zabbix proxy
shell> mysql -uzabbix -p<password> zabbix < images.sql
shell> mysql -uzabbix -p<password> zabbix < data.sql



vi /etc/nginx/nginx.conf
         location / {
            root   html;
            index  index.php index.html index.htm;
        }

        location ~ \.php$ {
            root           /usr/share/nginx/html;
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }
	
chmod -R zabbix:zabbix /usr/nginx/share/html		
chmod 757 /usr/share/nginx/html/assets/
nginx -t  #  检查配置文件
ningx   启功
nginx -s  stop    停止nginx
nginx -s  reload   
nginx -h               help


\cp -a /root/zabbix-4.0.19/frontends/php/*  /usr/share/nginx/html/


sed   -i '/post_max_size/s/8/16/g;/max_execution_time/s/30/300/g;/max_input_time/s/60/300/g;s/\;date.timezone.*/date.timezone \= PRC/g;s/\;always_populate_raw_post_data/always_populate_raw_post_data/g'  /etc/php.ini


vi /usr/local/zabbix/etc/zabbix_server.conf
LogFile=/tmp/zabbix_server.log
DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword=123456

cp  /root/zabbix-4.0.19/misc/init.d/tru64/zabbix_server  /etc/init.d/zabbix_server
chmod  o+x  /etc/init.d/zabbix_server
ln -s /usr/local/zabbix/sbin/zabbix_*  /usr/local/sbin/

/etc/init.d/zabbix_server  restart
systemctl start mariadb
systemctl start php-fpm
nginx 

 Admin  zabbix
 


mkdir <htdocs>/zabbix
cd frontends/php
cp -a . <htdocs>/zabbix
=====================================================================
agent:


yum -y install gcc curl curl-devel net-snmp net-snmp-devel perl-DBI libxml2-devel libevent-devel pcre mysql-devel
./configure --prefix=/usr/local/zabbix-agent  --enable-agent
make && make install

groupadd --system zabbix
useradd --system -g zabbix -d /usr/local/zabbix -s /sbin/nologin -c "Zabbix Monitoring System" zabbix
ln -s /usr/local/zabbix-agent/sbin/zabbix_agentd  /usr/local/sbin/zabbix_agentd
cp /root/zabbix-4.0.19/misc/init.d/tru64/zabbix_agentd /etc/init.d/zabbix_agentd
chmod o+x /etc/init.d/zabbix_agentd 
[root@centos84 ~]# grep -vE '^#|^$' /usr/local/zabbix-agent/etc/zabbix_agentd.conf
LogFile=/tmp/zabbix_agentd.log
Server=192.168.110.87
ServerActive=192.168.110.87
Hostname=centos84

/etc/init.d/zabbix_agentd start

========================================================


# rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
cd  zabbix-4.0

./configure --help    查看参数说明

yum -y install gcc curl curl-devel net-snmp net-snmp-devel perl-DBI libxml2-devel libevent-devel pcre mysql-devel
yum -y install gcc curl curl-devel net-snmp net-snmp-devel perl-DBI libxml2-devel libevent-devel pcre mysql-devel



./configure --prefix=/usr/local/zabbix-agent / --enable-agent --with-mysql --enable-ipv6 --with-net-snmp  --with-libcurl --with-libxml2

yum  install  epel-release -y
yum  install nginx -y

安装  php  。php-fpm
yum install  php php-devel  php-fpm  mariadb-server   mariadb-delvel


flush privileges

/etc/nginx/nginx.conf
server {
	listen       80;
	server_name  localhost;

	#charset koi8-r;

	#access_log  logs/host.access.log  main;

	location / {
		root   /usr/share/nginx/html;
		index  index.php index.html index.htm;
	}

	#error_page  404              /404.html;

	# redirect server error pages to the static page /50x.html
	#
	error_page   500 502 503 504  /50x.html;
	location = /50x.html {
		root   html;
	location = /50x.html {
		root   html;
	}

	# proxy the PHP scripts to Apache listening on 127.0.0.1:80
	#
	#location ~ \.php$ {
	#    proxy_pass   http://127.0.0.1;
	#}

	# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
	#
	location ~ \.php$ {
		root           /usr/share/nginx/html;
		fastcgi_pass   127.0.0.1:9000;
		fastcgi_index  index.php;
		fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
		include        fastcgi_params;
   }
   }
   
 systmctl  restart php-fpm
 
yum install php-gd php-mbstring php-bcmath php-mysql php-xml  gd-devel -y

nginx -c /etc/nginx/nginx.conf
==========================================================================

keepalived + nginx   高可用：
1. nignx：
/etc/nginx.conf
  在http 段中加入:
    upstream  web {
	server 192.168.110.81;
	server 192.168.110.82;
    }
  在server 段中加入：
   location / {
		proxy_pass http://web;
   }
2. keepalived：
/etc/keepalived/keepalived.conf
  master：
      vrrp_script check_nginx {
      script "/etc/keepalived/chk_nginx.sh"
      interval 1
      weight -20
    }
vrrp_instance VI_1 {
    state MASTER
    interface ens33
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.110.99
    }
    track_script {
        check_nginx
    }
}
BACKUP:
      vrrp_script check_nginx {
      script "/etc/keepalived/chk_nginx.sh"
      interval 1
      weight -20
    }
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 51
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.110.99
    }
    track_script {
        check_nginx
    }
}
/etc/keepalived/chk_nginx.sh
#!/bin/bash
if [ `ps -C nginx --no-header  | wc -l` -eq 0 ];then 
	killall keepalived
fi


chmod +x /etc/keepalived/chk_nginx.sh
======================================================================

